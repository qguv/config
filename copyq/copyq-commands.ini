[Commands]
1\Command="/*\nThis adds support for KDE, Gnome and Sway Wayland sessions.\n\nFor Sway, this requires:\n- `ydotool` utility to send copy/paste shortcuts to applications\n- `grim` for taking screenshot\n- `slurp` for selecting screenshot area\n\nFor KDE, this requires Spectacle for taking screenshots.\n\nGetting current window title is not supported in KDE.\n\nGlobal shortcut commands can be triggered with:\n\n    copyq triggerGlobalShortcut {COMMAND_NAME}\n\nOn Gnome, clipboard monitor is executed as X11 app using XWayland.\n\nLinks:\n- https://github.com/ReimuNotMoe/ydotool\n- https://github.com/emersion/grim\n- https://github.com/emersion/slurp\n*/\n\nfunction isSway() {\n    return env('SWAYSOCK').length != 0\n}\n\nfunction isGnome() {\n    return str(env('XAUTHORITY')).includes('mutter-Xwayland')\n}\n\nfunction run() {\n    var p = execute.apply(this, arguments)\n    if (!p) {\n        throw 'Failed to start ' + arguments[0]\n    }\n    if (p.exitCode && p.stderr.length) {\n        throw 'Failed command ' + arguments[0] + ': ' + str(p.stderr)\n    }\n    return p.stdout\n}\n\nfunction swayGetTree() {\n    var tree = run('swaymsg', '-t', 'get_tree')\n    return JSON.parse(str(tree))\n}\n\nfunction swayFindFocused(tree) {\n    var nodes = tree['nodes'].concat(tree['floating_nodes'])\n    for (var i in nodes) {\n        var node = nodes[i]\n        if (node['focused'])\n            return node\n        var focusedNode = swayFindFocused(node)\n        if (focusedNode)\n            return focusedNode\n    }\n    return undefined\n}\n\nfunction sendShortcut(shortcut) {\n    sleep(100)\n    run('ydotool', 'key', shortcut)\n}\n\nglobal.currentWindowTitle = function() {\n    if (!isSway())\n        return ''\n    var tree = swayGetTree()\n    var focusedNode = swayFindFocused(tree)\n    return focusedNode ? focusedNode['name'] : ''\n}\n\nglobal.paste = function() {\n    sendShortcut('shift+insert')\n}\n\nvar copy_ = global.copy\nglobal.copy = function() {\n    if (arguments.length == 0) {\n        sendShortcut('ctrl+c')\n    } else {\n        copy_.apply(this, arguments)\n    }\n}\n\nglobal.focusPrevious = function() {\n    hide()\n}\n\nvar monitorClipboard_ = monitorClipboard\nmonitorClipboard = function() {\n    if (isGnome() && env('QT_QPA_PLATFORM') != 'xcb') {\n        serverLog('Starting X11 clipboard monitor')\n        setEnv('QT_QPA_PLATFORM', 'xcb')\n        execute('copyq', '--clipboard-access', 'monitorClipboard')\n        serverLog('Stopping X11 clipboard monitor')\n        return\n    }\n    return monitorClipboard_()\n}\n\nvar onClipboardChanged_ = onClipboardChanged\nonClipboardChanged = function() {\n    var title = currentWindowTitle()\n    if (title)\n        setData(mimeWindowTitle, title)\n    onClipboardChanged_()\n}\n\nscreenshot = function(format, screenName) {\n    if (isSway())\n        return run('grim', '-t', format || 'png', '-')\n    return run(\n        'spectacle',\n        '--background',\n        '--nonotify',\n        '--pointer',\n        '--output',\n        '/dev/stdout',\n    )\n}\n\nscreenshotSelect = function(format, screenName) {\n    if (isSway()) {\n        var geometry = run('slurp')\n        geometry = str(geometry).trim()\n        return run('grim', '-c', '-g', geometry, '-t', format || 'png', '-')\n    }\n    return run(\n        'spectacle',\n        '--background',\n        '--nonotify',\n        '--pointer',\n        '--region',\n        '--output',\n        '/dev/stdout',\n    )\n}\n\nglobal.triggerGlobalShortcut = function(commandName) {\n    var cmds = commands()\n    for (var i in cmds) {\n        var cmd = cmds[i]\n        if (cmd.isGlobalShortcut && cmd.enable && cmd.name == commandName)\n            return action(cmd.cmd)\n    }\n    throw 'Failed to find enabled global command with given name'\n}"
1\Icon=\xf2d0
1\IsScript=true
1\Name=Wayland Support
2\Command="copyq:\nvar moveToTop = config('move') == 'true'\nvar activatePastes = config('activate_pastes') == 'true'\nvar activateCloses = config('activate_closes') == 'true'\nvar activateFocuses = config('activate_focuses') == 'true'\n\ncopy(mimeItems, input())\n\nif (moveToTop)\n    move(0)\n\nif (activateCloses)\n    hide()\n\nif (activateFocuses || activatePastes)\n    focusPrevious()\n\nif (activatePastes)\n    paste()"
2\Icon=\xf328
2\InMenu=true
2\Input=application/x-copyq-item
2\Name=Paste Items when Activated
2\Shortcut=enter, return
3\Command=copyq: plugins.itempinned.pin()
3\Icon=\xf08d
3\InMenu=true
3\Input=!OUTPUT
3\InternalId=copyq_pinned_pin
3\Name=Pin
3\Output=application/x-copyq-item-pinned
4\Command=copyq: plugins.itempinned.unpin()
4\Icon=\xf08d
4\InMenu=true
4\Input=application/x-copyq-item-pinned
4\InternalId=copyq_pinned_unpin
4\Name=Unpin
5\Command=copyq: plugins.itemtags.tag(decodeURIComponent('Important'))
5\Icon=\xf02b
5\InMenu=true
5\InternalId=copyq_tags_tag:Important
5\MatchCommand=copyq: plugins.itemtags.hasTag(decodeURIComponent('Important')) && fail()
5\Name=Tag as \x201cImportant\x201d
6\Command=copyq: plugins.itemtags.untag(decodeURIComponent('Important'))
6\Icon=\xf02b
6\InMenu=true
6\InternalId=copyq_tags_untag:Important
6\MatchCommand=copyq: plugins.itemtags.hasTag(decodeURIComponent('Important')) || fail()
6\Name=Remove tag \x201cImportant\x201d
7\Command=copyq: plugins.itemtags.tag()
7\Icon=\xf02b
7\InMenu=true
7\InternalId=copyq_tags_tag
7\Name=Add a Tag
8\Command=copyq: plugins.itemtags.untag()
8\Icon=\xf02b
8\InMenu=true
8\Input=application/x-copyq-tags
8\InternalId=copyq_tags_untag
8\Name=Remove a Tag
9\Command=copyq: plugins.itemtags.clearTags()
9\Icon=\xf02b
9\InMenu=true
9\Input=application/x-copyq-tags
9\InternalId=copyq_tags_clear
9\Name=Clear all tags
size=9
